<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Monitoring Dashboard - PMBlueprints</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .dashboard-header {
            background: #1e3a8a;
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e3a8a;
        }
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-healthy {
            color: #28a745;
        }
        .status-warning {
            color: #ffc107;
        }
        .status-error {
            color: #dc3545;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <h1> Performance Monitoring Dashboard</h1>
            <p class="mb-0">Real-time application performance metrics</p>
        </div>
    </div>

    <div class="container">
        <!-- Health Status -->
        <div class="row">
            <div class="col-12">
                <div class="metric-card">
                    <h3>System Health</h3>
                    <div class="d-flex align-items-center">
                        <span class="status-healthy" style="font-size: 3rem;">‚óè</span>
                        <div class="ms-3">
                            <div class="metric-value">Healthy</div>
                            <div class="metric-label">All systems operational</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="row">
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-label">Total Requests</div>
                    <div class="metric-value" id="total-requests">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-label">Avg Response Time</div>
                    <div class="metric-value" id="avg-response">-</div>
                    <small class="text-muted">milliseconds</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-label">Error Rate</div>
                    <div class="metric-value" id="error-rate">-</div>
                    <small class="text-muted">percent</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-label">Cache Hit Rate</div>
                    <div class="metric-value" id="cache-hit-rate">-</div>
                    <small class="text-muted">percent</small>
                </div>
            </div>
        </div>

        <!-- Activity Metrics -->
        <div class="row">
            <div class="col-md-4">
                <div class="metric-card text-center">
                    <div class="metric-label">Template Downloads</div>
                    <div class="metric-value" id="template-downloads">-</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card text-center">
                    <div class="metric-label">AI Generations</div>
                    <div class="metric-value" id="ai-generations">-</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card text-center">
                    <div class="metric-label">Active Users</div>
                    <div class="metric-value" id="active-users">-</div>
                </div>
            </div>
        </div>

        <!-- Top Endpoints -->
        <div class="row">
            <div class="col-md-6">
                <div class="metric-card">
                    <h4>Top Endpoints by Requests</h4>
                    <div class="chart-container">
                        <canvas id="endpoints-chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="metric-card">
                    <h4>Response Time Distribution</h4>
                    <div class="chart-container">
                        <canvas id="response-time-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Endpoint Details Table -->
        <div class="row">
            <div class="col-12">
                <div class="metric-card">
                    <h4>Endpoint Performance Details</h4>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Endpoint</th>
                                    <th>Requests</th>
                                    <th>Avg Response (ms)</th>
                                    <th>Min (ms)</th>
                                    <th>Max (ms)</th>
                                    <th>Errors</th>
                                </tr>
                            </thead>
                            <tbody id="endpoints-table">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fetch and update metrics
        async function updateMetrics() {
            try {
                const response = await fetch('/api/monitoring/metrics');
                const data = await response.json();
                
                // Update key metrics
                document.getElementById('total-requests').textContent = data.total_requests.toLocaleString();
                document.getElementById('error-rate').textContent = ((data.total_errors / data.total_requests) * 100 || 0).toFixed(2);
                document.getElementById('cache-hit-rate').textContent = data.cache.hit_rate.toFixed(2);
                
                // Update activity metrics
                document.getElementById('template-downloads').textContent = data.activity.template_downloads.toLocaleString();
                document.getElementById('ai-generations').textContent = data.activity.ai_generations.toLocaleString();
                document.getElementById('active-users').textContent = data.activity.active_users.toLocaleString();
                
                // Calculate average response time
                let totalResponseTime = 0;
                let totalEndpoints = 0;
                for (const [endpoint, stats] of Object.entries(data.endpoints)) {
                    totalResponseTime += stats.avg_response_time;
                    totalEndpoints++;
                }
                const avgResponse = totalEndpoints > 0 ? (totalResponseTime / totalEndpoints).toFixed(2) : 0;
                document.getElementById('avg-response').textContent = avgResponse;
                
                // Update endpoints table
                updateEndpointsTable(data.endpoints);
                
                // Update charts
                updateCharts(data.endpoints);
                
            } catch (error) {
                console.error('Error fetching metrics:', error);
            }
        }
        
        function updateEndpointsTable(endpoints) {
            const tbody = document.getElementById('endpoints-table');
            tbody.innerHTML = '';
            
            const sortedEndpoints = Object.entries(endpoints).sort((a, b) => b[1].requests - a[1].requests);
            
            for (const [endpoint, stats] of sortedEndpoints) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${endpoint}</code></td>
                    <td>${stats.requests.toLocaleString()}</td>
                    <td>${stats.avg_response_time.toFixed(2)}</td>
                    <td>${stats.min_response_time.toFixed(2)}</td>
                    <td>${stats.max_response_time.toFixed(2)}</td>
                    <td><span class="${stats.errors > 0 ? 'text-danger' : 'text-success'}">${stats.errors}</span></td>
                `;
                tbody.appendChild(row);
            }
        }
        
        let endpointsChart = null;
        let responseTimeChart = null;
        
        function updateCharts(endpoints) {
            const sortedEndpoints = Object.entries(endpoints).sort((a, b) => b[1].requests - a[1].requests).slice(0, 10);
            
            const labels = sortedEndpoints.map(([endpoint]) => endpoint.split('.').pop());
            const requests = sortedEndpoints.map(([, stats]) => stats.requests);
            const responseTimes = sortedEndpoints.map(([, stats]) => stats.avg_response_time);
            
            // Endpoints chart
            const endpointsCtx = document.getElementById('endpoints-chart').getContext('2d');
            if (endpointsChart) {
                endpointsChart.destroy();
            }
            endpointsChart = new Chart(endpointsCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Requests',
                        data: requests,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Response time chart
            const responseTimeCtx = document.getElementById('response-time-chart').getContext('2d');
            if (responseTimeChart) {
                responseTimeChart.destroy();
            }
            responseTimeChart = new Chart(responseTimeCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Avg Response Time (ms)',
                        data: responseTimes,
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Initial load
        updateMetrics();
        
        // Auto-refresh every 30 seconds
        setInterval(updateMetrics, 30000);
    </script>
</body>
</html>

