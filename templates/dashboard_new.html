{% extends "base.html" %}

{% block title %}Dashboard - PMBlueprints{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 fw-bold mb-1">Welcome back, {{ current_user.first_name }}!</h1>
                    <p class="text-muted mb-0">Manage your purchased templates and AI interactions</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-primary fs-6 px-3 py-2">{{ current_user.subscription_tier|title }} Plan</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 small">Purchased Templates</p>
                            <h3 class="fw-bold mb-0">{{ purchased_templates|length }}</h3>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                            <i class="fas fa-shopping-cart text-primary fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 small">AI Suggestions</p>
                            <h3 class="fw-bold mb-0">{{ ai_suggestions|length }}</h3>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded">
                            <i class="fas fa-lightbulb text-warning fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 small">AI Generations</p>
                            <h3 class="fw-bold mb-0">{{ ai_generations|length }}</h3>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded">
                            <i class="fas fa-magic text-success fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 small">AI Q&A Sessions</p>
                            <h3 class="fw-bold mb-0">{{ ai_questions|length }}</h3>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded">
                            <i class="fas fa-comments text-info fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content Area -->
        <div class="col-lg-8">
            <!-- Purchased Templates -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-folder-open me-2 text-primary"></i>My Purchased Templates
                        </h5>
                        <a href="{{ url_for('templates.browse') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-plus me-1"></i>Browse More
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if purchased_templates %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Template Name</th>
                                    <th>Category</th>
                                    <th>Industry</th>
                                    <th>Purchased</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for purchase in purchased_templates %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-file-{{ 'excel' if purchase.template.file_format == 'xlsx' else 'word' if purchase.template.file_format == 'docx' else 'powerpoint' }} me-2 text-primary"></i>
                                            <strong>{{ purchase.template.name }}</strong>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-light text-dark">{{ purchase.template.category }}</span></td>
                                    <td>{{ purchase.template.industry }}</td>
                                    <td class="text-muted small">{{ purchase.purchased_at.strftime('%b %d, %Y') }}</td>
                                    <td class="text-center">
                                        <a href="{{ url_for('templates.download', template_id=purchase.template.id) }}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-download me-1"></i>Download
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                        <p class="text-muted">You haven't purchased any templates yet.</p>
                        <a href="{{ url_for('templates.browse') }}" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Browse Templates
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- AI Suggestions History -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-lightbulb me-2 text-warning"></i>AI Suggestions History
                        </h5>
                        <a href="{{ url_for('ai_suggestions.index') }}" class="btn btn-sm btn-outline-warning">
                            <i class="fas fa-plus me-1"></i>Get New Suggestions
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if ai_suggestions %}
                    <div class="list-group list-group-flush">
                        {% for suggestion in ai_suggestions[:5] %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">{{ suggestion.industry }} - {{ suggestion.project_type }}</h6>
                                    <p class="text-muted small mb-1">
                                        <i class="fas fa-users me-1"></i>{{ suggestion.team_size }} | 
                                        <i class="fas fa-clock me-1"></i>{{ suggestion.timeline }} | 
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ suggestion.risk_level }}
                                    </p>
                                </div>
                                <small class="text-muted">{{ suggestion.created_at.strftime('%b %d, %Y') }}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="viewSuggestion({{ suggestion.id }})">
                                <i class="fas fa-eye me-1"></i>View Details
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% if ai_suggestions|length > 5 %}
                    <div class="text-center mt-3">
                        <a href="{{ url_for('ai_suggestions.index') }}" class="btn btn-sm btn-link">
                            View All {{ ai_suggestions|length }} Suggestions
                        </a>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-lightbulb fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No AI suggestions yet.</p>
                        <a href="{{ url_for('ai_suggestions.index') }}" class="btn btn-warning">
                            <i class="fas fa-magic me-1"></i>Get AI Suggestions
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- AI Generator History -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-magic me-2 text-success"></i>AI Generator History
                        </h5>
                        <a href="{{ url_for('ai_generator_page') }}" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-plus me-1"></i>Generate New Template
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if ai_generations %}
                    <div class="list-group list-group-flush">
                        {% for generation in ai_generations[:5] %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ generation.project_name or 'Untitled Project' }}</h6>
                                    <p class="text-muted small mb-1">
                                        <span class="badge bg-light text-dark me-1">{{ generation.template_type }}</span>
                                        <span class="badge bg-light text-dark me-1">{{ generation.industry }}</span>
                                        <span class="badge bg-{{ 'success' if generation.status == 'completed' else 'danger' }}">{{ generation.status|title }}</span>
                                    </p>
                                    <p class="mb-0 small text-muted">{{ generation.description[:100] }}...</p>
                                </div>
                                <small class="text-muted ms-2">{{ generation.created_at.strftime('%b %d') }}</small>
                            </div>
                            {% if generation.status == 'completed' %}
                            <button class="btn btn-sm btn-outline-primary" onclick="viewGeneration({{ generation.id }})">
                                <i class="fas fa-eye me-1"></i>View Generated Content
                            </button>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% if ai_generations|length > 5 %}
                    <div class="text-center mt-3">
                        <a href="{{ url_for('ai_generator_page') }}" class="btn btn-sm btn-link">
                            View All {{ ai_generations|length }} Generations
                        </a>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-magic fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No AI generations yet.</p>
                        <a href="{{ url_for('ai_generator_page') }}" class="btn btn-success">
                            <i class="fas fa-wand-magic me-1"></i>Generate Template
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- AI Q&A History -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-comments me-2 text-info"></i>AI Q&A History
                    </h5>
                </div>
                <div class="card-body">
                    {% if ai_questions %}
                    <div class="list-group list-group-flush">
                        {% for qa in ai_questions[:5] %}
                        <div class="list-group-item px-0 border-bottom">
                            <div class="mb-2">
                                <p class="mb-1 small"><strong>Q:</strong> {{ qa.question[:80] }}{% if qa.question|length > 80 %}...{% endif %}</p>
                                <p class="mb-1 small text-muted"><strong>A:</strong> {{ qa.answer[:100] if qa.answer else 'No answer yet' }}{% if qa.answer and qa.answer|length > 100 %}...{% endif %}</p>
                                <small class="text-muted">{{ qa.created_at.strftime('%b %d, %Y') }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if ai_questions|length > 5 %}
                    <div class="text-center mt-3">
                        <button class="btn btn-sm btn-link" onclick="viewAllQuestions()">
                            View All {{ ai_questions|length }} Questions
                        </button>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-comments fa-2x text-muted mb-2"></i>
                        <p class="text-muted small">No questions asked yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('templates.browse') }}" class="btn btn-outline-primary">
                            <i class="fas fa-search me-2"></i>Browse Templates
                        </a>
                        <a href="{{ url_for('ai_suggestions.index') }}" class="btn btn-outline-warning">
                            <i class="fas fa-lightbulb me-2"></i>Get AI Suggestions
                        </a>
                        <a href="{{ url_for('ai_generator_page') }}" class="btn btn-outline-success">
                            <i class="fas fa-magic me-2"></i>Generate Template
                        </a>
                        <a href="{{ url_for('auth.profile') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-user me-2"></i>Edit Profile
                        </a>
                    </div>
                </div>
            </div>

            <!-- Account Info -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-user-circle me-2"></i>Account Info
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted d-block">Email</small>
                        <strong>{{ current_user.email }}</strong>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block">Subscription Plan</small>
                        <strong>{{ current_user.subscription_plan|title }}</strong>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block">Member Since</small>
                        <strong>{{ current_user.created_at.strftime('%B %Y') if current_user.created_at else 'N/A' }}</strong>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('pricing') }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-crown me-1"></i>Upgrade Plan
                        </a>
                        <a href="{{ url_for('payment.billing_history') }}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-receipt me-1"></i>Billing History
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals for viewing details -->
<div class="modal fade" id="suggestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI Suggestion Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="suggestionModalBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="generationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generated Template Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="generationModalBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
function viewSuggestion(id) {
    // Load suggestion details via AJAX
    fetch(`/api/ai-suggestion/${id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('suggestionModalBody').innerHTML = formatSuggestion(data);
            new bootstrap.Modal(document.getElementById('suggestionModal')).show();
        });
}

function viewGeneration(id) {
    // Load generation details via AJAX
    fetch(`/api/ai-generation/${id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('generationModalBody').innerHTML = formatGeneration(data);
            new bootstrap.Modal(document.getElementById('generationModal')).show();
        });
}

function formatSuggestion(data) {
    return `
        <div class="mb-3">
            <h6>Project Details</h6>
            <p><strong>Industry:</strong> ${data.industry}</p>
            <p><strong>Project Type:</strong> ${data.project_type}</p>
            <p><strong>Timeline:</strong> ${data.timeline}</p>
            <p><strong>Risk Level:</strong> ${data.risk_level}</p>
        </div>
        <div>
            <h6>Suggestions</h6>
            <div>${data.suggestions}</div>
        </div>
    `;
}

function formatGeneration(data) {
    return `
        <div class="mb-3">
            <h6>${data.project_name}</h6>
            <p><strong>Type:</strong> ${data.template_type}</p>
            <p><strong>Industry:</strong> ${data.industry}</p>
            <p><strong>Description:</strong> ${data.description}</p>
        </div>
        <div>
            <h6>Generated Content</h6>
            <pre class="bg-light p-3 rounded">${data.generated_content}</pre>
        </div>
    `;
}

function viewAllQuestions() {
    // Redirect to AI Q&A page or show all in modal
    window.location.href = "{{ url_for('ai_suggestions.index') }}";
}
</script>
{% endblock %}

